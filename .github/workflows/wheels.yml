name: Wheels

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: wheels-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_wheels:
    name: Build wheel for ${{ matrix.python }}-${{ matrix.buildplat[1] }} ${{ matrix.buildplat[2] }}
    runs-on: ${{ matrix.buildplat[0] }}
    strategy:
      matrix:
        buildplat:
        - [ubuntu-22.04, manylinux, x86_64]
        - [ubuntu-22.04, manylinux, aarch64]
        - [macos-14, macosx, arm64]
        - [windows-2022, win, AMD64]
        - [windows-2022, win, ARM64]
        # Build all Python versions on main branch and tags, only 3.10 and 3.14 otherwise
        python: ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) && fromJSON('["cp310", "cp311", "cp312", "cp313", "cp314"]') || fromJSON('["cp310", "cp314"]') }}
      fail-fast: false

    env:
      IS_32_BIT: ${{ matrix.buildplat[2] == 'x86' }}
      MACOSX_DEPLOYMENT_TARGET: "${{ matrix.buildplat[0] == 'macos-13' && '13.0' || '14.0' }}"

    steps:
      - if: matrix.buildplat[2] == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_BUILD_VERBOSITY: 3
          # Install NetCDF on all platforms
          CIBW_BEFORE_BUILD_LINUX: bash .github/install_netcdf4.sh
          CIBW_BEFORE_BUILD_MACOS: bash .github/install_netcdf4.sh
          CIBW_BEFORE_BUILD_WINDOWS: powershell -ExecutionPolicy Bypass -File .github/install_netcdf4_windows.ps1
          CIBW_BUILD: ${{ matrix.python }}-${{ matrix.buildplat[1] }}*
          CIBW_ARCHS: ${{ matrix.buildplat[2] }}
          CIBW_ENVIRONMENT_PASS_LINUX: RUNNER_OS
          # Ensure pkg-config can find NetCDF (installed by before-all or before-build)
          CIBW_ENVIRONMENT_LINUX: PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/local/lib/pkgconfig
          CIBW_ENVIRONMENT_MACOS: >-
            PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig
            PATH=/opt/homebrew/bin:/usr/local/bin:$PATH
          # Windows: Set CMAKE_PREFIX_PATH to find NetCDF
          # Uses fixed path matching install_netcdf4_windows.ps1
          CIBW_ENVIRONMENT_WINDOWS: >-
            CMAKE_PREFIX_PATH="C:/netcdf-install"
            netCDF_DIR="C:/netcdf-install/lib/cmake/netCDF"
          # Test with NetCDF on all platforms
          CIBW_TEST_COMMAND: python -c "import muGrid; print(muGrid.__version__); from muGrid._muGrid import FileIONetCDF"

      - uses: actions/upload-artifact@v6
        with:
          path: ./wheelhouse/*.whl
          name: ${{ matrix.python }}-${{ matrix.buildplat[1] }}-${{ matrix.buildplat[2] }}

      - name: Check tag
        id: check-tag
        run: |
          if [[ ${{ github.ref }} =~ ^refs/tags/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo ::set-output name=match::true
          fi
        shell: bash

      - name: Deploy to PyPI
        if: steps.check-tag.outputs.match == 'true'
        run: |
          pip install twine
          twine upload wheelhouse/*.whl
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        shell: bash
