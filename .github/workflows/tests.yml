name: Tests

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: "0 2 * * 5"
jobs:
  tests:
    runs-on: ubuntu-24.04
    timeout-minutes: 45

    strategy:
      matrix:
        mpi: [ 'no', 'yes' ]
        compiler: [ 'gcc', 'clang' ]
        python-version: [ '3.10', '3.14' ]
        numpy-version: [ '>=2.1.0' ]
        mpi4py-version: [ '==4.0.3' ]
        exclude:
          - mpi: 'yes'
            compiler: 'clang'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          sudo apt-get update -qy
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            sudo apt-get install -y clang
          fi
          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install --upgrade pip
          # Install numpy
          pip install -v "numpy${{ matrix.numpy-version }}"
          if [ "${{ matrix.mpi }}" == "yes" ]; then
            sudo apt-get install -y \
              cmake \
              ninja-build \
              libboost-test-dev \
              openmpi-bin \
              libopenmpi-dev \
              libpnetcdf-dev \
              libnetcdf-dev
            # Install mpi4py
            echo "Installing mpi4py${{ matrix.mpi4py-version }}"
            CC=mpicc python3 -m pip install -v \
              --no-binary mpi4py \
              "mpi4py${{ matrix.mpi4py-version }}"
          else
            sudo apt-get install -y \
              cmake \
              ninja-build \
              libboost-test-dev \
              libnetcdf-dev
          fi
          python3 -m pip install build pytest numpy NuMPI[test] netCDF4
          python3 -m pip list

      - name: Compile with CMake
        run: |
          if [ "${{ matrix.compiler }}" == "clang" ]; then
            export CC=clang
            export CXX=clang++
          fi
          source venv/bin/activate
          # Explicitly tell CMake to use the venv Python so pytest is found
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DPython_EXECUTABLE=$(which python3)
          cd build
          cmake --build .

      - name: Run tests
        run: |
          source venv/bin/activate
          cd build
          ctest --output-on-failure

      - name: Test installation of Python extension module
        run: |
          source venv/bin/activate
          python3 -m pip install .

  # CUDA compile-only test (no GPU required)
  cuda-compile:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: '12.6.3'
          method: 'network'
          sub-packages: '["nvcc", "cudart-dev"]'
          non-cuda-sub-packages: '["libcufft-dev"]'

      - name: Install dependencies
        run: |
          sudo apt-get update -qy
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libboost-test-dev

      - name: Compile with CUDA enabled
        run: |
          echo "CUDA Toolkit installed at: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          nvcc --version
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DMUGRID_ENABLE_CUDA=ON \
            -DMUGRID_ENABLE_PYTHON=OFF \
            -DMUGRID_ENABLE_MPI=OFF \
            -DMUGRID_ENABLE_NETCDF=OFF \
            -DMUGRID_ENABLE_TESTS=ON \
            -DMUGRID_ENABLE_EXAMPLES=OFF \
            -DCMAKE_CUDA_ARCHITECTURES="70;80;90"
          cmake --build build

  # HIP/ROCm compile-only test (no GPU required)
  hip-compile:
    runs-on: ubuntu-24.04  # ROCm has better support on 22.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install ROCm/HIP
        run: |
          # Add ROCm repository
          sudo mkdir -p --mode=0755 /etc/apt/keyrings
          curl -fsSL https://repo.radeon.com/rocm/rocm.gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/rocm.gpg > /dev/null
          echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.2.4 jammy main" | sudo tee /etc/apt/sources.list.d/rocm.list > /dev/null
          # Set package priority to prefer ROCm repo over Ubuntu's packages
          echo -e 'Package: *\nPin: release o=repo.radeon.com\nPin-Priority: 600' | sudo tee /etc/apt/preferences.d/rocm-pin-600
          sudo apt-get update -qy
          # Install HIP development packages (no runtime/driver needed for compile-only)
          # hipcc: HIP compiler, hip-dev: headers, hipfft: FFT library
          # rocm-device-libs: device libraries needed by clang for GPU code generation
          # rocm-cmake: CMake support
          sudo apt-get install -y \
            hipcc \
            hip-dev \
            hipfft \
            rocm-device-libs \
            rocm-cmake

      - name: Install dependencies
        run: |
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libboost-test-dev

      - name: Compile with HIP enabled
        run: |
          # Set up HIP environment
          export HIP_PATH=/opt/rocm
          export PATH=$HIP_PATH/bin:$PATH
          export CMAKE_PREFIX_PATH=$HIP_PATH:$CMAKE_PREFIX_PATH
          hipcc --version || echo "hipcc not in PATH, checking /opt/rocm/bin"
          /opt/rocm/bin/hipcc --version
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DMUGRID_ENABLE_HIP=ON \
            -DMUGRID_ENABLE_PYTHON=OFF \
            -DMUGRID_ENABLE_MPI=OFF \
            -DMUGRID_ENABLE_NETCDF=OFF \
            -DMUGRID_ENABLE_TESTS=ON \
            -DMUGRID_ENABLE_EXAMPLES=OFF \
            -DCMAKE_HIP_ARCHITECTURES="gfx906;gfx908;gfx90a" \
            -DCMAKE_PREFIX_PATH=/opt/rocm
          cmake --build build
