name: GPU Tests

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  gpu-tests:
    runs-on: linux-x86-cuda
    timeout-minutes: 60

    strategy:
      matrix:
        python-version: ['3.10']

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: '12.6.3'
          method: 'network'
          sub-packages: '["nvcc", "cudart-dev", "nvrtc-dev"]'
          non-cuda-sub-packages: '["libcufft-dev", "libcublas-dev", "libcurand-dev"]'

      - name: Show GPU info
        run: |
          echo "=== NVIDIA SMI ==="
          nvidia-smi
          echo ""
          echo "=== CUDA Toolkit ==="
          echo "Installed at: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          nvcc --version

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update -qy
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libboost-test-dev

      - name: Install Python dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy pytest "NuMPI[test]" cupy-cuda12x

      - name: Configure with CMake (CUDA enabled)
        run: |
          source venv/bin/activate
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DMUGRID_ENABLE_CUDA=ON \
            -DMUGRID_ENABLE_PYTHON=ON \
            -DMUGRID_ENABLE_MPI=OFF \
            -DMUGRID_ENABLE_NETCDF=OFF \
            -DMUGRID_ENABLE_TESTS=ON \
            -DMUGRID_ENABLE_EXAMPLES=ON \
            -DCMAKE_CUDA_ARCHITECTURES="75" \
            -DPython_EXECUTABLE=$(which python3)

      - name: Build
        run: |
          source venv/bin/activate
          cmake --build build --parallel

      - name: Run C++ GPU tests
        run: |
          source venv/bin/activate
          cd build
          # Run all tests, GPU tests will actually execute on the Tesla T4
          ctest --output-on-failure -V

      - name: Run Python GPU tests
        run: |
          source venv/bin/activate
          # Install the built package
          python3 -m pip install .
          # Run GPU-specific Python tests
          cd tests
          python3 -m pytest python_field_gpu_tests.py -v -s
          python3 -m pytest python_fem_gradient_gpu_tests.py -v -s

      - name: Run Poisson example (host)
        run: |
          source venv/bin/activate
          export PYTHONPATH=$PWD/build/language_bindings/python:$PWD/language_bindings/python
          echo "=== Poisson 2D on HOST ==="
          python3 examples/poisson.py -n 32,32 -m host -s hardcoded -q
          echo ""
          echo "=== Poisson 3D on HOST ==="
          python3 examples/poisson.py -n 16,16,16 -m host -s hardcoded -q

      - name: Run Poisson example (device)
        run: |
          source venv/bin/activate
          export PYTHONPATH=$PWD/build/language_bindings/python:$PWD/language_bindings/python
          echo "=== Poisson 2D on DEVICE (GPU) ==="
          python3 examples/poisson.py -n 32,32 -m device -s hardcoded -q
          echo ""
          echo "=== Poisson 3D on DEVICE (GPU) ==="
          python3 examples/poisson.py -n 16,16,16 -m device -s hardcoded -q

      - name: Run Homogenization example (host)
        run: |
          source venv/bin/activate
          export PYTHONPATH=$PWD/build/language_bindings/python:$PWD/language_bindings/python
          echo "=== Homogenization 2D on HOST ==="
          python3 examples/homogenization.py -n 16,16 -m host -q
          echo ""
          echo "=== Homogenization 3D on HOST ==="
          python3 examples/homogenization.py -n 8,8,8 -m host -q

      - name: Run Homogenization example (device)
        run: |
          source venv/bin/activate
          export PYTHONPATH=$PWD/build/language_bindings/python:$PWD/language_bindings/python
          echo "=== Homogenization 2D on DEVICE (GPU) ==="
          python3 examples/homogenization.py -n 16,16 -m device -q
          echo ""
          echo "=== Homogenization 3D on DEVICE (GPU) ==="
          python3 examples/homogenization.py -n 8,8,8 -m device -q
